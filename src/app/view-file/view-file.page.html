<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/nueva-vizcaya"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ fileData?.fileName || 'View File' }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">

  <!-- Loading -->
  <div *ngIf="loading" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Loading file...</p>
  </div>

  <!-- Error -->
  <ion-card *ngIf="error">
    <ion-card-content class="error-text">
      {{ error }}
    </ion-card-content>
  </ion-card>

  <!-- File Content -->
  <div *ngIf="!loading && fileData" class="step-container">

    <!-- File Details -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>File Information</ion-card-title>
      </ion-card-header>

      <ion-card-content class="info-grid">

        <!-- File Name -->
        <div class="file-name-field">
          <strong>File Name:</strong> {{ fileData.fileName }}
        </div>

        <div><strong>Commodity:</strong> {{ fileData.commodityDisplay }}</div>
        <div><strong>Month:</strong> {{ fileData.month }}</div>
        <div *ngIf="fileData.week"><strong>Week:</strong> {{ fileData.week }}</div>
        <div><strong>Uploaded By:</strong> {{ fileData.uploadedByEmail }}</div>
        <div><strong>Uploaded At:</strong> {{ formatDate(fileData.uploadedAt) }}</div>
        <div><strong>Last Modified:</strong> {{ formatDate(fileData.lastModified) }}</div>

      </ion-card-content>
    </ion-card>

    <!-- Comparison Toggle -->
    <ion-card class="comparison-toggle-card">
      <ion-card-content>
        <div class="toggle-container">
          <div class="toggle-info">
            <div class="icon-wrapper">
              <!-- <ion-icon name="analytics-outline"></ion-icon> -->
            </div>
            <div>
              <h3>Price Comparison</h3>
              <p>Show historical price comparison and trends</p>
            </div>
          </div>
          <ion-toggle 
            [checked]="showComparison" 
            (ionChange)="onToggleChange($event)"
            [disabled]="loadingComparison"
            >
          </ion-toggle>
        </div>

        <!-- Loading State -->
        <div *ngIf="loadingComparison" class="loading-comparison">
          <ion-spinner name="dots"></ion-spinner>
          <span>Loading comparison data...</span>
        </div>

        <!-- Baseline Missing Warning -->
        <div *ngIf="showComparison && needsBaseline && !baselineExists" class="baseline-warning">
          <div class="warning-content">
            <div class="warning-text">
              <strong>Year-over-year comparison requires 2025 baseline data</strong>
              <p>Please setup baseline prices for October-December 2025 to enable comparison with previous year.</p>
            </div>
          </div>
          <ion-button 
            expand="block"  
            (click)="navigateToBaselineSetup()"
            class="setup-button">
            <ion-icon slot="start" name="add-circle-outline"></ion-icon>
            Setup 2025 Baseline Data
          </ion-button>
        </div>

        <!-- Summary Report Button - Only show when comparison is enabled -->
        <div *ngIf="showComparison && !loadingComparison && (!needsBaseline || baselineExists)" class="summary-button-container">
          <ion-button 
            expand="block" 
            (click)="toggleSummaryReport()"
            [disabled]="generatingSummary"
            class="summary-button">
            <ion-icon slot="start" [name]="showSummary ? 'eye-off-outline' : 'document-text-outline'"></ion-icon>
            {{ showSummary ? 'Hide Summary Report' : 'Generate Summary Report' }}
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Summary Report Section -->
    <div *ngIf="showSummary" class="summary-view-container">
      <ion-card class="summary-header-card">
        <ion-card-header>
          <div class="summary-header-content">
            <ion-card-title>Price Comparison Summary Report</ion-card-title>
            <ion-button 
              (click)="exportSummaryReport()" 
              size="small" 
              fill="solid" 
              class="export-summary-btn">
              <ion-icon slot="start" name="download-outline"></ion-icon>
              Export Summary
            </ion-button>
          </div>
        </ion-card-header>
      </ion-card>

      <div class="summary-content">

        <!-- 1 Month Summary Card -->
        <div class="summary-card">
          <h3 class="summary-title">1 Month Comparison Summary</h3>

          <!-- A. Increase -->
          <div class="summary-section">
            <span class="summary-label"><strong>A. Increase</strong></span>
            <span class="summary-value"></span>
          </div>

          <div class="summary-section">
            <span class="summary-label">Total Increase:</span>
            <span class="summary-value">{{ summary.month1.increaseCount }}</span>
          </div>

          <div class="summary-section">
            <span class="summary-label">Highest Increase:</span>
            <span class="summary-value">
              <div *ngFor="let item of summary.month1.highestIncrease" class="multi-item">
                {{ item }}
              </div>
              <div *ngIf="summary.month1.highestIncrease.length === 0" class="no-data">
                No data
              </div>
            </span>
          </div>

          <div class="summary-section">
            <span class="summary-label">Lowest Increase:</span>
            <span class="summary-value">
              <div *ngFor="let item of summary.month1.lowestIncrease" class="multi-item">
                {{ item }}
              </div>
              <div *ngIf="summary.month1.lowestIncrease.length === 0" class="no-data">
                No data
              </div>
            </span>
          </div>

          <!-- B. Decrease -->
          <div class="bar"><br></div>
          <div class="summary-section">
            <span class="summary-label"><strong>B. Decrease</strong></span>
            <span class="summary-value"></span>
          </div>

          <div class="summary-section">
            <span class="summary-label">Total Decrease:</span>
            <span class="summary-value">{{ summary.month1.decreaseCount }}</span>
          </div>

          <div class="summary-section">
            <span class="summary-label">Highest Decrease:</span>
            <span class="summary-value">
              <div *ngFor="let item of summary.month1.highestDecrease" class="multi-item">
                {{ item }}
              </div>
              <div *ngIf="summary.month1.highestDecrease.length === 0" class="no-data">
                No data
              </div>
            </span>
          </div>

          <div class="summary-section">
            <span class="summary-label">Lowest Decrease:</span>
            <span class="summary-value">
              <div *ngFor="let item of summary.month1.lowestDecrease" class="multi-item">
                {{ item }}
              </div>
              <div *ngIf="summary.month1.lowestDecrease.length === 0" class="no-data">
                No data
              </div>
            </span>
          </div>

          <!-- Total Number of Products -->
          <div class="bar"><br></div>
          <div class="summary-section total-products">
            <span class="summary-label"><strong>Total Number of Products:</strong></span>
            <span class="summary-value"><strong>{{ summary.month1.totalProducts }}</strong></span>
          </div>
        </div>

        <!-- 3 Months Summary Card -->
        <div class="summary-card">
          <h3 class="summary-title">3 Months Comparison Summary</h3>

          <!-- A. Increase -->
          <div class="summary-section">
            <span class="summary-label"><strong>A. Increase</strong></span>
            <span class="summary-value"></span>
          </div>

          <div class="summary-section">
            <span class="summary-label">Total Increase:</span>
            <span class="summary-value">{{ summary.month3.increaseCount }}</span>
          </div>

          <div class="summary-section">
            <span class="summary-label">Highest Increase:</span>
            <span class="summary-value">
              <div *ngFor="let item of summary.month3.highestIncrease" class="multi-item">
                {{ item }}
              </div>
              <div *ngIf="summary.month3.highestIncrease.length === 0" class="no-data">
                No data
              </div>
            </span>
          </div>

          <div class="summary-section">
            <span class="summary-label">Lowest Increase:</span>
            <span class="summary-value">
              <div *ngFor="let item of summary.month3.lowestIncrease" class="multi-item">
                {{ item }}
              </div>
              <div *ngIf="summary.month3.lowestIncrease.length === 0" class="no-data">
                No data
              </div>
            </span>
          </div>

          <!-- B. Decrease -->
          <div class="bar"><br></div>
          <div class="summary-section">
            <span class="summary-label"><strong>B. Decrease</strong></span>
            <span class="summary-value"></span>
          </div>

          <div class="summary-section">
            <span class="summary-label">Total Decrease:</span>
            <span class="summary-value">{{ summary.month3.decreaseCount }}</span>
          </div>

          <div class="summary-section">
            <span class="summary-label">Highest Decrease:</span>
            <span class="summary-value">
              <div *ngFor="let item of summary.month3.highestDecrease" class="multi-item">
                {{ item }}
              </div>
              <div *ngIf="summary.month3.highestDecrease.length === 0" class="no-data">
                No data
              </div>
            </span>
          </div>

          <div class="summary-section">
            <span class="summary-label">Lowest Decrease:</span>
            <span class="summary-value">
              <div *ngFor="let item of summary.month3.lowestDecrease" class="multi-item">
                {{ item }}
              </div>
              <div *ngIf="summary.month3.lowestDecrease.length === 0" class="no-data">
                No data
              </div>
            </span>
          </div>

          <!-- Total Number of Products -->
          <div class="bar"><br></div>
          <div class="summary-section total-products">
            <span class="summary-label"><strong>Total Number of Products:</strong></span>
            <span class="summary-value"><strong>{{ summary.month3.totalProducts }}</strong></span>
          </div>
        </div>

      </div>
    </div>

    <!-- Price Table -->
    <ion-card class="price-table-card" *ngIf="!showSummary">
      <ion-card-header>
        <div class="price-data-header">
          <ion-card-title>Price Data</ion-card-title>
          <div class="header-actions">
            <ion-button (click)="exportToExcel()" [disabled]="loading || !fileData" size="small" fill="solid">
              <ion-icon slot="start" name="download-outline"></ion-icon>
              Export
            </ion-button>
            <ion-searchbar 
              [(ngModel)]="searchText" 
              (ionInput)="onSearchChange($event)"
              placeholder="Search products"
              animated
              class="price-search">
            </ion-searchbar>
          </div>
        </div>
      </ion-card-header>

      <ion-card-content>
        <div class="table-wrapper">
          <table class="price-table">

            <thead>
              <tr>
                <th class="product-column">Product Name</th>
                <th class="unit-column">Unit</th>
                <th *ngFor="let store of fileData.stores" class="store-column">
                  {{ store }}
                </th>
                <th class="prevailing-column">{{ getPrevailingPriceLabel() }}</th>

                <!-- Comparison Columns -->
                <ng-container *ngIf="showComparison">
                  <!-- Week Ago (only for Isabela & Cagayan) -->
                  <ng-container *ngIf="needsWeekComparison()">
                    <th class="comparison-column">Prevailing Price<br>1 Week Ago</th>
                    <th class="difference-column" colspan="2">Price Difference<br>(Peso | Percent)</th>
                  </ng-container>

                  <!-- 1 Month Ago -->
                  <th class="comparison-column">Prevailing Price<br>1 Month Ago</th>
                  <th class="difference-column" colspan="2">Price Difference<br>(Peso | Percent)</th>

                  <!-- 3 Months Ago -->
                  <th class="comparison-column">Prevailing Price<br>3 Months Ago</th>
                  <th class="difference-column" colspan="2">Price Difference<br>(Peso | Percent)</th>
                </ng-container>
              </tr>
            </thead>

            <tbody>
              <ng-container *ngFor="let category of getFilteredCategories()">

                <tr class="category-row">
                  <td class="category-header">
                    <strong>{{ category.name }}</strong>
                  </td>
                  <td [attr.colspan]="showComparison ? (fileData.stores.length + 2 + (getComparisonColumnCount() * 3)) : (fileData.stores.length + 2)"></td>
                </tr>

                <tr *ngFor="let product of category.products" class="product-row">
                  <td class="product-name">{{ product.name }}</td>
                  <td class="unit-cell">{{ product.unit || '—' }}</td>

                  <td *ngFor="let store of fileData.stores; let i = index" class="price-cell">
                    {{ product.prices[i] !== null ? (product.prices[i] | number:'1.2-2') : '—' }}
                  </td>

                  <td class="prevailing-cell">
                    <div class="prevailing-price">
                      {{ product.prevailingPrice !== null ? (product.prevailingPrice | number:'1.2-2') : '—' }}
                    </div>
                  </td>

                  <!-- Comparison Data -->
                  <ng-container *ngIf="showComparison">
                    <!-- Week Ago Comparison (Isabela & Cagayan only) -->
                    <ng-container *ngIf="needsWeekComparison()">
                      <td class="comparison-cell">
                        {{ getPriceFromComparison(product.name, product.unit || '', category.name, comparisonData.weekAgo) !== null 
                           ? (getPriceFromComparison(product.name, product.unit || '', category.name, comparisonData.weekAgo) | number:'1.2-2') 
                           : '—' }}
                      </td>
                      <td class="difference-cell" 
                          [ngClass]="getDifferenceClass(calculatePriceDifference(product.prevailingPrice, getPriceFromComparison(product.name, product.unit || '', category.name, comparisonData.weekAgo)), product.prevailingPrice, getPriceFromComparison(product.name, product.unit || '', category.name, comparisonData.weekAgo))"
                          colspan="2">
                        {{ formatDifference(calculatePriceDifference(product.prevailingPrice, getPriceFromComparison(product.name, product.unit || '', category.name, comparisonData.weekAgo))) }}
                      </td>
                    </ng-container>

                    <!-- 1 Month Ago Comparison -->
                    <td class="comparison-cell">
                      {{ getPriceFromComparison(product.name, product.unit || '', category.name, comparisonData.monthAgo) !== null 
                         ? (getPriceFromComparison(product.name, product.unit || '', category.name, comparisonData.monthAgo) | number:'1.2-2') 
                         : '—' }}
                    </td>
                    <td class="difference-cell" 
                        [ngClass]="getDifferenceClass(calculatePriceDifference(product.prevailingPrice, getPriceFromComparison(product.name, product.unit || '', category.name, comparisonData.monthAgo)), product.prevailingPrice, getPriceFromComparison(product.name, product.unit || '', category.name, comparisonData.monthAgo))"
                        colspan="2">
                      {{ formatDifference(calculatePriceDifference(product.prevailingPrice, getPriceFromComparison(product.name, product.unit || '', category.name, comparisonData.monthAgo))) }}
                    </td>

                    <!-- 3 Months Ago Comparison -->
                    <td class="comparison-cell">
                      {{ getPriceFromComparison(product.name, product.unit || '', category.name, comparisonData.threeMonthsAgo) !== null 
                         ? (getPriceFromComparison(product.name, product.unit || '', category.name, comparisonData.threeMonthsAgo) | number:'1.2-2') 
                         : '—' }}
                    </td>
                    <td class="difference-cell" 
                        [ngClass]="getDifferenceClass(calculatePriceDifference(product.prevailingPrice, getPriceFromComparison(product.name, product.unit || '', category.name, comparisonData.threeMonthsAgo)), product.prevailingPrice, getPriceFromComparison(product.name, product.unit || '', category.name, comparisonData.threeMonthsAgo))"
                        colspan="2">
                      {{ formatDifference(calculatePriceDifference(product.prevailingPrice, getPriceFromComparison(product.name, product.unit || '', category.name, comparisonData.threeMonthsAgo))) }}
                    </td>
                  </ng-container>
                </tr>

              </ng-container>
            </tbody>

          </table>
        </div>
      </ion-card-content>
    </ion-card>

  </div>
</ion-content>